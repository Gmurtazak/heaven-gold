<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Digital Form</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f9;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      min-height: 100vh;
    }
    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin: 50px auto;
      width: 90%;
      max-width: 800px;
    }
    .dashboard a {
      text-decoration: none;
    }
    .dashboard button {
      width: 100%;
      padding: 20px;
      font-size: 18px;
      border: none;
      border-radius: 10px;
      background: #007bff;
      color: white;
      cursor: pointer;
      transition: 0.3s;
    }
    .dashboard button:hover {
      background: #0056b3;
    }
    footer {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: #333;
      color: #fff;
      text-align: center;
      padding: 10px 0;
      font-size: 14px;
    }
  </style>
  <script>
document.addEventListener('DOMContentLoaded', function () {
  const banner = document.getElementById('expiry-banner') || (function(){
    const d = document.createElement('div');
    d.id = 'expiry-banner';
    document.body.prepend(d);
    return d;
  })();

  // ---- Configuration ----
  const expiryDate = new Date("2025-10-17");
  const today = new Date();
  const diffTime = expiryDate - today;
  const daysLeft = Math.max(0, Math.ceil(diffTime / (1000 * 60 * 60 * 24)));

  // ---- Banner Content ----
  banner.innerHTML = '';
  const inner = document.createElement('div');
  inner.className = 'banner-inner';

  const msg = document.createElement('div');
  msg.className = 'message';
  msg.innerHTML = `Your <strong><b>Free Trial Extension</b></strong> and services are going to expire within 
                   <strong>${daysLeft} day${daysLeft !== 1 ? 's' : ''}</strong>. 
                   Kindly upgrade your Plan, otherwise all services will be stopped.`;

  const controls = document.createElement('div');
  controls.className = 'controls';

  // ---- Purchase button (generate invoice) ----
  const btnPurchase = document.createElement('button');
  btnPurchase.type = 'button';
  btnPurchase.className = 'purchase';
  btnPurchase.textContent = 'Purchase';
  btnPurchase.addEventListener('click', generateInvoicePDF);

  // small status text next to button
  const statusText = document.createElement('span');
  statusText.id = 'invoiceStatus';
  statusText.style.marginLeft = '10px';
  statusText.style.fontSize = '0.95em';
  statusText.style.color = '#333';

  controls.appendChild(btnPurchase);
  controls.appendChild(statusText);
  inner.appendChild(msg);
  inner.appendChild(controls);
  banner.appendChild(inner);

  requestAnimationFrame(() => {
    banner.classList.add('show');
  });

  // ---- Helpers ----

  // Format number with commas and 2 decimals
  const currencyFormatter = new Intl.NumberFormat('en-PK', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

  function formatCurrency(num) {
    return currencyFormatter.format(Number(Number(num).toFixed(2)));
  }

  // Convert number to words (Indian system) including paise
  function numberToWordsIndian(amount) {
    // amount is number or numeric string
    amount = Number(amount);
    if (isNaN(amount)) return '';

    const ones = ['', 'one','two','three','four','five','six','seven','eight','nine','ten','eleven','twelve','thirteen','fourteen','fifteen','sixteen','seventeen','eighteen','nineteen'];
    const tens = ['', '', 'twenty','thirty','forty','fifty','sixty','seventy','eighty','ninety'];

    function twoDigitWords(n) {
      n = Number(n);
      if (n < 20) return ones[n];
      const t = Math.floor(n / 10);
      const o = n % 10;
      return tens[t] + (o ? ' ' + ones[o] : '');
    }

    function threeDigitWords(n) {
      n = Number(n);
      const h = Math.floor(n / 100);
      const r = n % 100;
      let str = '';
      if (h) str += ones[h] + ' hundred';
      if (r) str += (str ? ' ' : '') + twoDigitWords(r);
      return str;
    }

    // Split into integer rupees and paise
    const rupees = Math.floor(amount);
    const paise = Math.round((amount - rupees) * 100);

    if (rupees === 0 && paise === 0) return 'zero rupees only';

    // Indian groups: crore (10^7), lakh (10^5), thousand (10^3), hundred
    let n = rupees;
    const parts = [];

    const crore = Math.floor(n / 10000000);
    if (crore) {
      parts.push(threeDigitWords(crore) + ' crore');
      n = n % 10000000;
    }

    const lakh = Math.floor(n / 100000);
    if (lakh) {
      parts.push(threeDigitWords(lakh) + ' lakh');
      n = n % 100000;
    }

    const thousand = Math.floor(n / 1000);
    if (thousand) {
      parts.push(threeDigitWords(thousand) + ' thousand');
      n = n % 1000;
    }

    if (n) {
      parts.push(threeDigitWords(n));
    }

    const rupeesWords = parts.join(' ').replace(/\s+/g, ' ').trim();

    let result = '';
    if (rupees > 0) {
      result += rupeesWords + (rupees === 1 ? ' rupee' : ' rupees');
    }

    if (paise > 0) {
      if (result) result += ' and ';
      result += (paise < 100 ? twoDigitWords(paise) : threeDigitWords(paise)) + (paise === 1 ? ' paise' : ' paise');
    }

    result = result + ' only';
    return result;
  }

  // -------- Generate invoice PDF function --------
  async function generateInvoicePDF() {
    try {
      // disable button and show status
      btnPurchase.disabled = true;
      btnPurchase.style.opacity = '0.6';
      statusText.textContent = 'Generating invoice...';

      const invoice = document.getElementById('invoice');
      if (!invoice) {
        throw new Error('Invoice element with id="invoice" not found on the page.');
      }
      invoice.style.display = 'block'; // show temporarily for capture

      // Fill invoice data
      const invNumEl = document.getElementById('invNum');
      const invDateEl = document.getElementById('invDate');
      if (invNumEl) invNumEl.textContent = 'INV-' + Date.now();
      if (invDateEl) invDateEl.textContent = new Date().toLocaleDateString();

      const phpExtensions = [
        "mbstring",
        "curl",
        "gd",
        "openssl",
        "pdo_mysql",
        "zip",
        "intl",
        "json"
      ];

      const items = [
        { name: "PHP Service", details: "Barcode Generator & API Service", price: 30750 },
        { name: "Service Integration", details: "Barcode Customization", price: 21450 },
        { name: "PHP Extensions", details: phpExtensions.join(", "), price: 14790 }
      ];

      // Populate items table with formatted numbers
      const tbody = document.getElementById('itemsBody');
      if (!tbody) throw new Error('Table body with id="itemsBody" not found.');
      tbody.innerHTML = "";
      let total = 0;
      items.forEach(it => {
        total += Number(it.price || 0);
        const tr = document.createElement('tr');
        const tdName = document.createElement('td');
        tdName.textContent = it.name;
        const tdDetails = document.createElement('td');
        tdDetails.textContent = it.details;
        const tdPrice = document.createElement('td');
        tdPrice.textContent = 'PKR ' + formatCurrency(it.price);
        tr.appendChild(tdName);
        tr.appendChild(tdDetails);
        tr.appendChild(tdPrice);
        tbody.appendChild(tr);
      });

      // Update total with commas
      const totalPriceEl = document.getElementById('totalPrice');
      if (totalPriceEl) totalPriceEl.textContent = "PKR " + formatCurrency(total);

      // Show amount in words (element with id "totalInWords")
      const totalWordsEl = document.getElementById('totalInWords');
      if (totalWordsEl) {
        totalWordsEl.textContent = "Amount in words: " + numberToWordsForDisplay(total);
      }

      // Build extensions / bank details list
      const extList = document.getElementById('extensionsList');
      if (extList) {
        extList.textContent = ''; // clear existing
        const rows = [
          ['Name', 'NASIR AND CO.'],
          ['Account no', 'PK89DUIB0000000272933004'],
          ['Bank', 'Dubai Islamic Bank Pakistan'],
          ['SWIFT', 'DUIBPKKAXXX']
        ];

        rows.forEach(([label, value]) => {
          const row = document.createElement('div');
          const strong = document.createElement('strong');
          strong.textContent = label + ': ';
          row.appendChild(strong);
          row.appendChild(document.createTextNode(value));
          extList.appendChild(row);
        });

        // Add final message
        const note = document.createElement('p');
        note.style.marginTop = '10px';
        note.innerHTML = `
          <em>After making the payment, please send your deposit slip to 
          <a href="mailto:support@tapboxesSolution.com">support@tapboxesSolution.com</a>. 
          Once verified, your extension plan will be upgraded.</em>
        `;
        extList.appendChild(note);
      }

      // -------- PDF generation using html2canvas + jsPDF (supports multi-page) --------
      const { jsPDF } = window.jspdf;
      if (!window.html2canvas) throw new Error('html2canvas not found. Please include html2canvas library.');

      // increase scale to improve quality; may increase size
      const canvas = await html2canvas(invoice, { scale: 2, useCORS: true, logging: false });
      const imgData = canvas.toDataURL('image/png');

      const pdf = new jsPDF({ unit: 'mm', format: 'a4' });
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();

      // margins
      const margin = 10;
      const usableWidth = pageWidth - margin * 2;
      const usableHeight = pageHeight - margin * 2;

      const imgWidth = usableWidth;
      const imgHeight = (canvas.height * imgWidth) / canvas.width;

      // if image fits in one page
      if (imgHeight <= usableHeight) {
        pdf.addImage(imgData, 'PNG', margin, margin, imgWidth, imgHeight);
      } else {
        // slice and add multiple pages
        let remainingHeight = imgHeight;
        let position = 0;
        const pageCanvas = document.createElement('canvas');
        const pageCtx = pageCanvas.getContext('2d');

        // scale factor from canvas px to pdf mm
        const pxPerMm = canvas.width / imgWidth; // px per mm

        // compute page slice height in px
        const sliceHeightPx = Math.floor(usableHeight * pxPerMm);

        pageCanvas.width = canvas.width;
        pageCanvas.height = sliceHeightPx;

        let y = 0;
        while (y < canvas.height) {
          // draw portion of original canvas into pageCanvas
          pageCtx.clearRect(0, 0, pageCanvas.width, pageCanvas.height);
          pageCtx.drawImage(canvas, 0, y, canvas.width, sliceHeightPx, 0, 0, pageCanvas.width, pageCanvas.height);
          const pageData = pageCanvas.toDataURL('image/png');
          if (y === 0) {
            pdf.addImage(pageData, 'PNG', margin, margin, imgWidth, usableHeight);
          } else {
            pdf.addPage();
            pdf.addImage(pageData, 'PNG', margin, margin, imgWidth, usableHeight);
          }
          y += sliceHeightPx;
        }
      }

      const fileName = `invoice-${Date.now()}.pdf`;
      pdf.save(fileName);

      // hide invoice again
      invoice.style.display = 'none';

      // show completed status briefly
      statusText.textContent = 'Invoice generated';
      setTimeout(() => { statusText.textContent = ''; }, 3000);

    } catch (err) {
      console.error(err);
      const statusTextEl = document.getElementById('invoiceStatus');
      if (statusTextEl) statusTextEl.textContent = 'Error: ' + (err.message || 'Unable to generate PDF');
      alert('Error generating invoice: ' + (err.message || err));
    } finally {
      btnPurchase.disabled = false;
      btnPurchase.style.opacity = '1';
    }
  }

  // Wrapper that converts a numeric value to words with paise included using numberToWordsIndian
  function numberToWordsForDisplay(amount) {
    // ensure 2 decimals
    const amt = Number(Number(amount).toFixed(2));
    return numberToWordsIndian(amt);
  }

});
</script>
<style>
    #expiry-banner {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: #ff4d4d;
      color: #fff;
      text-align: center;
      padding: 12px;
      font-family: Arial, sans-serif;
      font-size: 16px;
      z-index: 9999;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      display: none; /* hidden by default */
    }
    #expiry-banner button {
      background: #fff;
      color: #ff4d4d;
      border: none;
      padding: 6px 12px;
      margin-left: 15px;
      font-weight: bold;
      cursor: pointer;
      border-radius: 4px;
    }
</style>
</head>
  <!-- invoice section (hidden, used for PDF) -->
<div id="invoice" style="display:none; padding:20px; font-family:Arial;">
  <center><h2>TapboxesSolution Limited</h2><center>
  <p><strong>Invoice:</strong> <span id="invNum"></span><br>
     <strong>Date:</strong> <span id="invDate"></span></p>
  <table border="1" cellspacing="0" cellpadding="6" width="100%">
    <thead>
      <tr><th>Service</th><th>Details</th><th>Price (PKR)</th></tr>
    </thead>
    <tbody id="itemsBody"></tbody>
    <tfoot>
      <tr><td colspan="2" style="text-align:right"><strong>Total </strong></td>
          <td id="totalPrice"></td></tr>
    </tfoot>
  </table>
  <h3>Account detail:</h3>
  <ul id="extensionsList"></ul>
</div>

<body>
  <div id="expiry-banner" role="status" aria-live="polite">yyyyyyy</div>
  <h2>Digital Form</h2>
  <div class="dashboard">
    <a target="_blank" href="application-form.html"><button>Application Form</button></a>
        <a target="_blank" href="confirmation-letter.html"><button>Confirmation Letter</button></a>
        <a target="_blank" href="allotment-Letter.html"><button>Allotment Letter</button></a>
   <a target="_blank" href="receipt-form.html"><button>Receipt Form</button></a>
   <a target="_blank" href="payment-schedule.html"><button>Payment Schedule</button></a>
    <a target="_blank" href="payment-schedule-2.html"><button>Payment Schedule - 2</button></a>
     <a target="_blank" href="payment-schedule-3.html"><button>Payment Schedule - 3</button></a>
     <!-- <a target="_blank" href="booking-form.html"><button>Booking Form</button></a>
   
   
 -->
  </div>

  <footer>
    Software design by Ghulam Murtaza | 0323-2054415
  </footer>
</body>
</html>
